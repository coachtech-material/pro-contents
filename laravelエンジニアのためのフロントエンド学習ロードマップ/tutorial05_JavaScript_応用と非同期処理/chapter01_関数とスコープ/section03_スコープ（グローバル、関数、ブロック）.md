# 5-1-3: スコープ（グローバル、関数、ブロック）

## Chapter 1: 関数とスコープ

### Section 3: スコープ（グローバル、関数、ブロック）

🎯 **このセクションで学ぶこと**

-   **スコープ**とは何か、変数が参照できる範囲の概念を理解する。
-   グローバルスコープ、関数スコープ、ブロックスコープの違いを説明できるようになる。
-   `var`が引き起こすスコープの問題点と、なぜ`let`と`const`が推奨されるのかを深く理解する。

--- 

### イントロダクション：変数の「縄張り」を理解する

プログラムが大きくなってくると、「この変数はどこから参照できて、どこからは参照できないのか？」という問題が非常に重要になります。もし、どこからでもすべての変数が書き換え可能だったら、意図しない場所で値が変更され、プログラムはあっという間に混乱してしまうでしょう。

この、**変数が有効な範囲（変数の縄張り）**のことを**スコープ**と呼びます。スコープを正しく理解することは、バグを未然に防ぎ、見通しの良いコードを書くための必須スキルです。

JavaScriptのスコープには、主に3つの種類があります。そして、`var`と`let`/`const`では、このスコープの扱いが決定的に異なります。この違いを理解することが、このセクションの最大のゴールです。

--- 

### ⚙️ 1. グローバルスコープ (Global Scope)

どの関数やブロック`{}`の内側でもない、最も外側で宣言された変数が持つスコープです。グローバルスコープで宣言された変数は、プログラムの**どこからでも**アクセスできます。

```javascript
const globalMessage = "こんにちは、グローバル！"; // グローバルスコープ

function sayHello() {
  console.log(globalMessage); // 関数内からアクセス可能
}

sayHello(); // "こんにちは、グローバル！"
console.log(globalMessage); // もちろん外側からもアクセス可能
```

**注意点:** グローバル変数は便利に見えますが、多用は避けるべきです。意図しない場所で値が上書きされたり、他のライブラリと名前が衝突したりする原因となり、大規模な開発では管理が困難になります。グローバル変数の使用は、必要最小限に留めましょう。

### ⚙️ 2. 関数スコープ (Function Scope)

**`var`で**変数を宣言した場合、その変数は**宣言された関数の中全体**で有効になります。これを関数スコープと呼びます。

```javascript
function myFunction() {
  var message = "こんにちは、関数スコープ！"; // この関数内でのみ有効
  console.log(message);
}

myFunction(); // "こんにちは、関数スコープ！"

console.log(message); // ReferenceError: message is not defined
```

### ⚙️ 3. ブロックスコープ (Block Scope)

**`let`または`const`で**変数を宣言した場合、その変数は**宣言されたブロック`{}`の中**でのみ有効になります。これをブロックスコープと呼びます。`if`文や`for`ループの`{}`もブロックスコープを作ります。

```javascript
if (true) {
  let blockMessage = "こんにちは、ブロックスコープ！"; // このifブロック内でのみ有効
  console.log(blockMessage);
}

// "こんにちは、ブロックスコープ！"

console.log(blockMessage); // ReferenceError: blockMessage is not defined
```

ブロックスコープは、関数スコープよりも「縄張り」が狭く、より限定的です。これにより、変数が意図しない範囲に影響を及ぼすことを防ぎ、安全なコードを書くことができます。

--- 

### ⚠️ 最重要： `var`（関数スコープ） vs `let`/`const`（ブロックスコープ）

この2つのスコープの違いが最も顕著に現れる例を見てみましょう。

```javascript
function compareScopes() {
  if (true) {
    var varVariable = "私はvar";
    let letVariable = "私はlet";
  }

  console.log(varVariable); // "私はvar" -> 表示される！
  console.log(letVariable); // ReferenceError: letVariable is not defined
}

compareScopes();
```

-   `varVariable`は`var`で宣言されているため、**関数スコープ**を持ちます。`if`ブロックの中で宣言されていますが、その効力は`compareScopes`関数全体に及びます。そのため、`if`ブロックの外側からでもアクセスできてしまいます。
-   `letVariable`は`let`で宣言されているため、**ブロックスコープ**を持ちます。その効力は`if`ブロックの中だけに限定されます。そのため、ブロックの外側からアクセスしようとするとエラーになります。

`for`ループでも同様の問題が起こります。

```javascript
for (var i = 0; i < 3; i++) {
  // ...
}
console.log(i); // 3 -> ループの外からアクセスできてしまう！

for (let j = 0; j < 3; j++) {
  // ...
}
console.log(j); // ReferenceError: j is not defined
```

`var`のこの挙動は、長年JavaScriptのバグの主要な原因とされてきました。変数の影響範囲が広すぎ、意図しない挙動を引き起こしやすいためです。

**結論：`var`はもはや使うべきではありません。変数の宣言には、常に`let`または`const`を使用してください。** これにより、変数のスコープは常に最小限のブロックスコープに保たれ、より安全で予測可能なコードを書くことができます。

--- 

✨ **まとめ**

-   **スコープ**とは、変数が参照できる有効範囲のことである。
-   **グローバルスコープ**はプログラム全体からアクセスできるが、多用は避けるべきである。
-   `var`で宣言された変数は、関数全体で有効な**関数スコープ**を持つ。
-   `let`/`const`で宣言された変数は、`{}`ブロック内でのみ有効な**ブロックスコープ**を持つ。
-   ブロックスコープの方がスコープが狭く安全なため、現代のJavaScriptでは`var`を使わず、常に`let`と`const`を使うことが強く推奨される。

📝 **学習のポイント**

-   [ ] グローバルスコープ、関数スコープ、ブロックスコープの違いを、それぞれのスコープを持つ変数の宣言方法と関連付けて説明してください。
-   [ ] なぜ`var`ではなく`let`や`const`を使うべきなのでしょうか？`if`文を使った具体的なコード例を挙げて説明してください。
-   [ ] `const user = { name: '山田' };` のようにオブジェクトを`const`で宣言した場合、`user.name = '鈴木';` のようにプロパティを変更することは可能ですか？それはなぜですか？（ヒント: `const`が不変にするのは「値」そのものであり、オブジェクトの場合は「参照」が不変になります）
