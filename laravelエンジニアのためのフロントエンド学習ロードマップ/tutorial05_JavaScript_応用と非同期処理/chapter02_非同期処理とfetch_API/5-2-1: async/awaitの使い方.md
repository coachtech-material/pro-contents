# 5-2-1: async/awaitの使い方

## 🎯 このセクションで学ぶこと

- JavaScriptにおける非同期処理の必要性を理解する
- Promiseの基本的な概念を把握する
- `async/await` を使って、同期的（逐次的）に見える直感的な非同期コードを書けるようになる

## 導入

JavaScriptは**シングルスレッド**で動作する言語です。これは、一度に一つの処理しか実行できないことを意味します。もし時間のかかる処理（例えば、外部サーバーから大量のデータを取得するなど）を同期的に実行すると、その処理が終わるまで後続の処理がすべてブロックされ、結果としてWebページの操作ができなくなったり（UIが固まる）、アニメーションが停止したりします。

このような問題を解決するのが**非同期処理**です。非同期処理を用いることで、時間のかかる処理をバックグラウンドで実行させ、その完了を待たずに次の処理に進むことができます。

## 詳細解説

### Promiseとは？

Promiseは、非同期処理の最終的な結果（成功または失敗）を表すオブジェクトです。Promiseは以下の3つの状態を持ちます。

- **`pending`**: 待機中。非同期処理がまだ完了していない状態。
- **`fulfilled`**: 成功。非同期処理が成功し、結果の値が利用可能な状態。
- **`rejected`**: 失敗。非同期処理が失敗した状態。

従来、Promiseを扱うには `.then()` や `.catch()` といったメソッドチェーンが使われていましたが、処理が複雑になるとコードがネストし、読みにくくなることがありました（「コールバック地獄」と呼ばれることも）。

### `async/await` の登場

ES2017で導入された `async/await` は、このPromiseをより直感的かつ同期的なコードのように扱うための構文（シンタックスシュガー）です。

#### `async` 関数

関数の前に `async` キーワードを付けると、その関数は**非同期関数**となります。非同期関数は、常にPromiseを返します。

```javascript
async function myFunction() {
  return "Hello";
}

myFunction().then(console.log); // "Hello" と出力される
```

#### `await` 演算子

`await` 演算子は、`async` 関数内でのみ使用でき、Promiseが `fulfilled` または `rejected` の状態になるまで関数の実行を一時停止します。

- Promiseが成功（`fulfilled`）した場合、`await` はその結果の値を返します。
- Promiseが失敗（`rejected`）した場合、`await` はエラーをスローします（後述する `try...catch` で補足できます）。

### コード例

`setTimeout` を使って、1秒後にメッセージを返す擬似的な非同期処理を考えてみましょう。

**Promiseを使った基本的な例**
```javascript
function wait(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function greeting() {
  console.log("処理を開始します");

  // 1秒待つ
  await wait(1000);

  console.log("1秒経過しました");
  return "こんにちは！";
}

greeting().then(message => console.log(message));

// 出力結果:
// 処理を開始します
// (1秒後)
// 1秒経過しました
// こんにちは！
```

`await wait(1000)` の部分で、`wait` 関数が返すPromiseが解決される（`setTimeout` のタイマーが完了する）まで、`greeting` 関数の実行が一時停止されます。これにより、まるで同期処理のように上から下へ順番にコードが実行されているように見え、非常に読みやすくなります。

## 💡 TIP

- `await` は `async` が付いた関数の直下でしか使えません。トップレベル（関数の外）で `await` を使いたい場合は、トップレベルawaitという機能がありますが、環境によってはサポートされていない場合があります。

## ✨ まとめ

- `async` は関数に付けるキーワードで、その関数がPromiseを返すことを示す。
- `await` は `async` 関数内でPromiseの結果を待つために使う演算子。
- `async/await` を活用することで、非同期処理のコードを、同期的で直感的なスタイルで記述できる。
