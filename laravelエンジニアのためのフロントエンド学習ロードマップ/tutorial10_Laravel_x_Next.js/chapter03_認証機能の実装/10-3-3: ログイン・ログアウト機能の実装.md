# 10-3-3: ログイン・ログアウト機能の実装

## 🎯 このセクションで学ぶこと

-   Laravel側に、ログイン、ログアウト、ユーザー情報取得のためのAPIエンドポイントを作成する方法を学ぶ
-   Next.jsで、ログインフォームコンポーネントを作成する方法を習得する
-   NextAuth.jsの`signIn`, `signOut`関数を使って、実際にログイン・ログアウト処理を実行する方法を学ぶ
-   `useSession`フックを使って、認証状態に応じてUIを動的に変更する方法を理解する

## 導入

これまでのセクションで、バックエンド（Sanctum）とフロントエンド（NextAuth.js）の認証設定が完了しました。しかし、これらはまだ連携しておらず、実際にユーザーが操作できるUIもありません。

このセクションでは、いよいよ両者を結びつけ、ユーザーが実際にログイン・ログアウトできる機能を実装します。具体的には、以下の作業を行います。

1.  **Laravel**: NextAuth.jsが要求するログイン、ログアウト、ユーザー情報取得のAPIを作成します。
2.  **Next.js**: ログインフォームを作成し、NextAuth.jsの関数を呼び出してLaravelのAPIと通信します。また、認証状態を表示するUIも作成します。

## 詳細解説

### パート1: バックエンド（Laravel）の実装

**注意**: このパートの作業は、すべてLaravelプロジェクトのディレクトリ（`laravel-next-app`）で行います。

#### ステップ1: 認証ルートの有効化

Laravelは、`laravel/ui`や`laravel/breeze`といったパッケージを導入することで、認証関連のルートやコントローラーを自動で生成してくれます。今回は、APIに必要なルートだけをシンプルに追加します。

`routes/api.php`に以下のコードを追加してください。

```php
// routes/api.php

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\ProductController;

// 商品一覧API（変更なし）
Route::get("/products", [ProductController::class, "index"]);

// 認証済みユーザーのみアクセス可能なルート
Route::middleware("auth:sanctum")->get("/user", function (Request $request) {
    return $request->user();
});
```

次に、`routes/web.php`にログイン・ログアウトのルートを追加します。SPA認証では、セッションを開始・破棄するために、これらのルートは`web`ミドルウェアグループ（CSRF保護などを含む）内に定義する必要があります。

```php
// routes/web.php

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Route;

// ...

// ログイン
Route::post("/login", function (Request $request) {
    $credentials = $request->validate([
        "email" => ["required", "email"],
        "password" => ["required"],
    ]);

    if (Auth::attempt($credentials)) {
        $request->session()->regenerate();

        return response()->json(Auth::user());
    }

    return response()->json([
        "message" => "The provided credentials do not match our records.",
    ], 401);
});

// ログアウト
Route::post("/logout", function (Request $request) {
    Auth::guard("web")->logout();

    $request->session()->invalidate();

    $request->session()->regenerateToken();

    return response()->noContent();
});
```

**コードのポイント:**

-   **`/api/user`**: `auth:sanctum`ミドルウェアで保護されています。これにより、有効なセッションを持つリクエスト（認証済みリクエスト）だけがこのルートにアクセスでき、認証済みのユーザーモデルを取得できます。NextAuth.jsの`authorize`コールバックで、ログイン直後にこのエンドポイントを叩いていましたね。
-   **`/login`**: `Auth::attempt`ファサードを使って、リクエストで送られてきたメールアドレスとパスワードで認証を試みます。成功すれば、セッションを再生成（セキュリティ対策）し、ユーザー情報をJSONで返します。
-   **`/logout`**: `Auth::guard('web')->logout()`でセッションからユーザー情報を削除し、セッションを無効化・再生成してログアウトを完了させます。

#### ステップ2: テスト用ユーザーの作成

ログイン機能を試すために、テスト用のユーザーが必要です。`tinker`を使って作成しましょう。

```bash
sail artisan tinker
```

`tinker`の対話コンソールで、以下のPHPコードを実行します。

```php
// tinker

\App\Models\User::create([
    'name' => 'Test User',
    'email' => 'test@example.com',
    'password' => bcrypt('password'),
]);
```

これで、メールアドレス `test@example.com`、パスワード `password` のユーザーが作成されました。

### パート2: フロントエンド（Next.js）の実装

**注意**: このパートの作業は、すべてNext.jsプロジェクトのディレクトリ（`next-frontend-app`）で行います。

#### ステップ1: ログインページの作成

NextAuth.jsの設定で `pages: { signIn: '/login' }` と指定したので、`src/app/login/page.tsx`を作成します。

```tsx
// src/app/login/page.tsx
"use client";

import { useState } from "react";
import { signIn } from "next-auth/react";
import { useRouter } from "next/navigation";

export default function LoginPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const router = useRouter();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError("");

    const result = await signIn("credentials", {
      redirect: false, // 認証後の自動リダイレクトを無効化
      email,
      password,
    });

    if (result?.error) {
      setError("メールアドレスまたはパスワードが正しくありません。");
    } else if (result?.ok) {
      router.push("/"); // 認証成功後にトップページにリダイレクト
    }
  };

  return (
    <div className="flex items-center justify-center min-h-screen bg-gray-100">
      <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
        <h1 className="text-2xl font-bold text-center">ログイン</h1>
        <form onSubmit={handleSubmit} className="space-y-6">
          <div>
            <label
              htmlFor="email"
              className="block text-sm font-medium text-gray-700"
            >
              メールアドレス
            </label>
            <input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              className="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div>
            <label
              htmlFor="password"
              className="block text-sm font-medium text-gray-700"
            >
              パスワード
            </label>
            <input
              id="password"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              className="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          {error && <p className="text-sm text-red-600">{error}</p>}
          <div>
            <button
              type="submit"
              className="w-full px-4 py-2 font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
              ログイン
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
```

**コードのポイント:**

-   **`"use client"`**: フォーム入力の状態管理（`useState`）やイベントハンドリング（`onSubmit`）など、クライアントサイドのインタラクションが必要なため、Client Componentとして定義します。
-   **`signIn("credentials", ...)`**: NextAuth.jsが提供する`signIn`関数を呼び出しています。第一引数に`providers`で設定した認証方法（今回は`credentials`）を指定し、第二引数にフォームの入力値とオプションを渡します。
-   **`redirect: false`**: `signIn`のデフォルトの挙動は、認証後に自動で元のページにリダイレクトするというものです。ここでは`false`に設定し、認証結果（成功か失敗か）を`result`オブジェクトとして受け取り、手動で画面遷移やエラー表示を制御しています。

#### ステップ2: 認証状態を表示するヘッダーの作成

ログインしているかどうか、誰がログインしているかを表示し、ログイン/ログアウトのリンクを提供するためのヘッダーコンポーネントを作成します。

`src/app/components/Header.tsx`という新しいファイルを作成します。

```tsx
// src/app/components/Header.tsx
"use client";

import { useSession, signOut } from "next-auth/react";
import Link from "next/link";

export default function Header() {
  const { data: session, status } = useSession();

  return (
    <header className="bg-white shadow-md">
      <nav className="container mx-auto px-6 py-4 flex justify-between items-center">
        <Link href="/" className="text-xl font-bold text-gray-800">
          MyApp
        </Link>
        <div>
          {status === "loading" ? (
            <p>Loading...</p>
          ) : session ? (
            <div className="flex items-center space-x-4">
              <p>ようこそ, {session.user?.name}さん</p>
              <button
                onClick={() => signOut({ callbackUrl: "/login" })}
                className="px-4 py-2 font-medium text-white bg-red-600 rounded-md hover:bg-red-700"
              >
                ログアウト
              </button>
            </div>
          ) : (
            <Link
              href="/login"
              className="px-4 py-2 font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700"
            >
              ログイン
            </Link>
          )}
        </div>
      </nav>
    </header>
  );
}
```

**コードのポイント:**

-   **`useSession()`**: NextAuth.jsが提供する最も重要なフックです。認証状態（`status`）とセッションデータ（`data`）を取得します。
    -   `status`: `"loading"` | `"authenticated"` | `"unauthenticated"` のいずれかの文字列。
    -   `data`: 認証されている場合はセッションオブジェクト、されていない場合は`null`。
-   **状態に応じたUIの分岐**: `status`と`session`の値に応じて、ローディング表示、ユーザー名とログアウトボタン、ログインボタンを出し分けています。
-   **`signOut()`**: ログアウト処理を実行します。`callbackUrl`を指定すると、ログアウト後にそのURLにリダイレクトされます。

#### ステップ3: レイアウトにヘッダーを追加

作成した`Header`コンポーネントを、`src/app/layout.tsx`で表示するようにします。

```tsx
// src/app/layout.tsx

// ... (importなどは変更なし)
import Header from "./components/Header"; // Headerをインポート

// ...

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <Providers>
          <Header /> {/* Headerコンポーネントを追加 */}
          {children}
        </Providers>
      </body>
    </html>
  );
}
```

### パート3: 動作確認

すべての実装が完了しました。実際に動作を確認してみましょう。

1.  Next.jsの開発サーバーが起動していることを確認し、`http://localhost:3000`にアクセスします。ヘッダーに「ログイン」ボタンが表示されているはずです。
2.  「ログイン」ボタンをクリックすると、`/login`ページに遷移します。
3.  メールアドレスに`test@example.com`、パスワードに`password`と入力してログインボタンを押します。
4.  成功するとトップページにリダイレクトされ、ヘッダーが「ようこそ, Test Userさん」と「ログアウト」ボタンに変わります。
5.  商品一覧ページ（`/products`）にアクセスしても、ログイン状態が維持されていることを確認します。
6.  「ログアウト」ボタンを押すと、ログインページにリダイレクトされ、ヘッダーが再び「ログイン」ボタンに戻ります。

## ✨ まとめ

-   Laravel側で、`web`ミドルウェアグループ内にログイン・ログアウト用のルートを、`api`ミドルウェアグループ内に認証済みユーザー情報を返すルートを定義した。
-   Next.jsでログインフォームを作成し、`signIn("credentials", ...)`関数を呼び出して認証処理を実行した。
-   `useSession`フックを使って認証状態を取得し、UIを動的に切り替える方法を学んだ。
-   `signOut()`関数でログアウト処理を実装した。

これで、LaravelとNext.jsを連携させた、本格的な認証機能が完成しました。次のハンズオンで、このチャプター全体の流れを復習しましょう。
