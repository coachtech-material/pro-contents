# 上級コラム: Webレンダリング深層理解

## Chapter 1: ブラウザの気持ちになって考える

### Section 1: クリティカルレンダリングパスとは

🎯 **このセクションで学ぶこと**

-   ブラウザがHTML、CSS、JavaScriptを受け取ってから、画面にピクセルを描画するまでの一連の流れである「クリティカルレンダリングパス」の全体像を理解する。
-   DOM、CSSOM、レンダーツリー、レイアウト、ペイントといった各ステージの役割を説明できるようになる。
-   なぜ`<script>`タグを`<body>`の最後に置くのが良いとされるのか、その理由をレンダリングパスの観点から説明できるようになる。

--- 

### イントロダクション：Webページの「原材料」から「完成品」まで

ユーザーがブラウザでURLにアクセスしたとき、舞台裏では何が起きているのでしょうか？

ブラウザは、サーバーから送られてきたHTML、CSS、JavaScriptといった「原材料」を解釈し、それらを組み合わせて、ユーザーが見ることのできる視覚的なWebページという「完成品」を作り上げます。この、**ブラウザが最初のHTMLレスポンスを受け取ってから、画面にピクセルを描画するまでの一連のステップ**のことを、**クリティカルレンダリングパス（Critical Rendering Path）**と呼びます。

このパスを理解することは、Webサイトのパフォーマンスを最適化し、ユーザー体験を向上させる上で極めて重要です。なぜなら、このパスのどこかが非効率だと、ページの表示が遅れ、ユーザーは白い画面を長く見つめることになってしまうからです。

--- 

### 🚶 クリティカルレンダリングパスの旅

クリティカルレンダリングパスは、大きく分けて以下のステップで構成されます。

![クリティカルレンダリングパス](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/images/crp.png?hl=ja)
*（画像引用元: Google for Developers）*

1.  **DOMツリーの構築 (DOM Tree)**
2.  **CSSOMツリーの構築 (CSSOM Tree)**
3.  **レンダーツリーの構築 (Render Tree)**
4.  **レイアウト (Layout / Reflow)**
5.  **ペイント (Paint / Rasterization)**

それぞれのステップを詳しく見ていきましょう。

#### Step 1: DOM (Document Object Model) ツリーの構築

-   **入力**: HTMLコード
-   **出力**: DOMツリー

ブラウザは、サーバーから受け取ったHTMLを上から一行ずつ解釈（パース）し、タグをノード（Node）に変換していきます。そして、HTMLの入れ子構造を反映したツリー構造をメモリ上に構築します。これが**DOMツリー**です。

```html
<html>
  <head>
    <title>My Page</title>
  </head>
  <body>
    <h1>Hello, World!</h1>
    <p>This is a paragraph.</p>
  </body>
</html>
```

上記のHTMLは、以下のようなDOMツリーに変換されます。

```
- document
  - html
    - head
      - title
        - "My Page"
    - body
      - h1
        - "Hello, World!"
      - p
        - "This is a paragraph."
```

DOMツリーは、Webページの**コンテンツ**そのものを表現しています。

#### Step 2: CSSOM (CSS Object Model) ツリーの構築

-   **入力**: CSSコード
-   **出力**: CSSOMツリー

HTMLのパース中に`<link>`タグや`<style>`タグでCSSが見つかると、ブラウザはCSSの解釈も開始します。CSSのルールを解釈し、どの要素にどのスタイルが適用されるかという情報をツリー構造で表現します。これが**CSSOMツリー**です。

```css
body { font-size: 16px; }
p { color: blue; }
```

CSSOMツリーは、DOMツリーと同様に、親のスタイルが子に継承されるカスケードの性質を反映したツリー構造になります。

**重要な注意点：CSSはレンダリングをブロックする**
ブラウザは、すべてのCSSを解釈し、CSSOMツリーを構築し終えるまで、ページのレンダリングを開始しません。なぜなら、後から読み込まれたCSSルールによって、それ以前に描画した部分のスタイルが変更される可能性があるからです。これを「**CSSはレンダリングブロッキングリソースである**」と言います。

#### Step 3: レンダーツリー (Render Tree) の構築

-   **入力**: DOMツリー + CSSOMツリー
-   **出力**: レンダーツリー

DOMツリー（コンテンツ）とCSSOMツリー（スタイル）が完成すると、ブラウザはこれら2つを結合して**レンダーツリー**を構築します。

レンダーツリーは、**実際に画面に表示される要素だけ**で構成されます。例えば、`display: none;`が指定された要素や、`<head>`タグのように視覚的に表示されない要素は、レンダーツリーには含まれません。

レンダーツリーの各ノードは、コンテンツとスタイルの両方の情報を持っています。例えば、「`p`ノードは、『This is a paragraph.』というテキストを持ち、色は青で、フォントサイズは16pxである」といった情報です。

#### Step 4: レイアウト (Layout)

-   **入力**: レンダーツリー
-   **出力**: 各ノードの正確な位置とサイズ

レンダーツリーが構築されると、次に行われるのが**レイアウト**（または**リフロー**）です。このステップでは、ブラウザのビューポート（表示領域）のサイズに基づいて、レンダーツリーの各ノードが画面上の**どこに、どのくらいの大きさで**配置されるかを計算します。

`width: 50%`や`font-size: 2em`といった相対的な単位は、このレイアウトステージで具体的なピクセル値に変換されます。

#### Step 5: ペイント (Paint)

-   **入力**: レイアウト情報
-   **出力**: 画面上のピクセル

レイアウトステージで各ノードの幾何学的な情報（位置、サイズ）が確定すると、ブラウザはついに画面にピクセルを描画します。これが**ペイント**です。

このステップでは、テキスト、色、画像、境界線、影といった、各ノードの視覚的な情報を、レイアウトで計算された各領域に実際に「塗りつぶして」いきます。ブラウザは、パフォーマンスのために複数のレイヤーに分けて描画し、最後にそれらを合成（Compositing）して最終的な画面を生成します。

--- 

### 🤔 JavaScriptはどこに影響する？

JavaScriptは、DOMやCSSOMを動的に操作できるため、クリティカルレンダリングパスに大きな影響を与えます。

-   **DOM操作**: `document.createElement()`や`element.appendChild()`などでDOMツリーを変更すると、それに伴いレンダーツリーの再構築、レイアウト、ペイントが再度発生する可能性があります。
-   **CSSOM操作**: `element.style.color = 'red'`などでスタイルを変更すると、同様に再レイアウトや再ペイントがトリガーされます。

**重要な注意点：JavaScriptはパースをブロックする**
ブラウザは、HTMLのパース中に`<script>`タグ（`async`や`defer`属性がないもの）を見つけると、**HTMLのパースを中断**し、JavaScriptのダウンロード、パース、実行を優先します。なぜなら、そのJavaScriptが`document.write()`などでDOM構造自体を変更する可能性があるからです。

これが、**`<script>`タグを`<body>`の最後に置くことが推奨される**大きな理由です。先にHTMLのパースを完了させ、DOMツリーを構築することで、ユーザーはJavaScriptが実行される前にページのコンテンツを見ることができるようになり、体感的な表示速度が向上します。

--- 

✨ **まとめ**

-   **クリティカルレンダリングパス**は、ブラウザがコードを受け取ってから画面にピクセルを描画するまでの一連のプロセスである。
-   パスは、**DOM構築 → CSSOM構築 → レンダーツリー構築 → レイアウト → ペイント**というステップで進む。
-   **DOM**はコンテンツの構造、**CSSOM**はスタイルのルールを表す。
-   **レンダーツリー**は、表示される要素とそのスタイルを組み合わせたものである。
-   **レイアウト**は要素のサイズと位置を計算し、**ペイント**は実際にピクセルを描画する。
-   CSSは**レンダリングをブロック**し、JavaScriptは**HTMLのパースをブロック**する。これらの特性を理解することが、パフォーマンス最適化の鍵となる。

📝 **学習のポイント**

-   [ ] Chromeのデベロッパーツールにある「Performance」タブを使うと、Webサイトのクリティカルレンダリングパスを視覚的に分析することができます。実際にいくつかのサイトでプロファイルを取得し、どのような処理に時間がかかっているか観察してみましょう。
-   [ ] `<script>`タグに付与できる`async`属性と`defer`属性は、JavaScriptによるパースブロッキングをどのように緩和するのでしょうか？それぞれの挙動の違いを調べてみましょう。
-   [ ] 「リフロー」と「リペイント」の違いについて説明してください。`opacity`プロパティの変更はリフローを引き起こしますか？ `margin`プロパティの変更はどうでしょうか？
