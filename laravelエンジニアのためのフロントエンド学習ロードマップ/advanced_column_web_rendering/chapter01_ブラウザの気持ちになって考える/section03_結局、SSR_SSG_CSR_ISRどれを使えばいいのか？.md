# 上級コラム: Webレンダリング深層理解

## Chapter 1: ブラウザの気持ちになって考える

### Section 3: 結局、SSR, SSG, CSR, ISRどれを使えばいいのか？

🎯 **このセクションで学ぶこと**

-   現代のWebアプリケーションで主流となっている4つのレンダリング戦略（SSR, SSG, CSR, ISR）の基本的な仕組みと特徴を理解する。
-   それぞれの戦略が、パフォーマンス（TTFB, FCP, TTI）、SEO、開発体験にどのような影響を与えるかを比較できるようになる。
-   アプリケーションの要件（コンテンツの更新頻度、動的な性質、ユーザー体験の優先度など）に基づいて、最適なレンダリング戦略を選択するための判断基準を身につける。

--- 

### イントロダクション：レンダリング戦略の戦国時代

Next.jsのようなモダンなフロントエンドフレームワークは、単一のレンダリング手法に縛られません。開発者は、ページの特性に応じて、複数のレンダリング戦略を柔軟に使い分けることができます。しかし、選択肢が多いということは、同時に「どれを選べば良いのか？」という新たな問いを生み出します。

-   **SSR (Server-Side Rendering)**: サーバーサイドレンダリング
-   **SSG (Static Site Generation)**: 静的サイト生成
-   **CSR (Client-Side Rendering)**: クライアントサイドレンダリング
-   **ISR (Incremental Static Regeneration)**: インクリメンタル静的再生成

これらのアルファベットの羅列は、それぞれが「**誰が、いつ、HTMLを生成するのか**」という点で異なります。このセクションでは、それぞれの戦略を解き明かし、あなたのプロジェクトに最適な選択を下すための羅針盤を提供します。

--- 

### ⚔️ 4つのレンダリング戦略

#### 1. CSR (Client-Side Rendering)

-   **仕組み**: 
    1.  ブラウザは、サーバーからほぼ空っぽのHTMLファイルと、巨大なJavaScriptバンドルを受け取る。
    2.  ブラウザがJavaScriptを実行し、APIからデータを取得し、DOMを構築してページ全体をレンダリングする。
-   **誰が**: **クライアント（ブラウザ）**
-   **いつ**: **実行時（ランタイム）**
-   **長所**:
    -   一度読み込んでしまえば、ページ遷移が高速（ブラウザ内で完結するため）。
    -   サーバーの負荷が低い。
    -   静的なファイル配信で済むため、ホスティングが容易。
-   **短所**:
    -   **TTFB（Time to First Byte）**は速いが、**FCP（First Contentful Paint）**と**TTI（Time to Interactive）**が非常に遅い。ユーザーは長々とローディングスピナーを見ることになる。
    -   **SEOに弱い**。多くのクローラーはJavaScriptを実行しないか、不完全にしか実行しないため、コンテンツがインデックスされない可能性がある。
-   **適した用途**: ログイン後の管理画面、ダッシュボードなど、SEOが重要でなく、インタラクティブ性が高いアプリケーション。

#### 2. SSR (Server-Side Rendering)

-   **仕組み**: 
    1.  ユーザーからリクエストが来るたびに、サーバーが対応するページのHTMLを**動的に生成**して返す。
    2.  ブラウザは、すでにコンテンツが描画されたHTMLを受け取るため、すぐに表示できる。
    3.  その後、ブラウザがJavaScriptを読み込み、ページをインタラクティブにする（このプロセスを**ハイドレーション**と呼ぶ）。
-   **誰が**: **サーバー**
-   **いつ**: **リクエストごと**
-   **長所**:
    -   **FCPが速い**。ユーザーはすぐにコンテンツを見ることができる。
    -   **SEOに非常に強い**。サーバーが完全なHTMLを返すため、クローラーが確実にコンテンツをインデックスできる。
-   **短所**:
    -   **TTFBが遅くなる**傾向がある。サーバーはリクエストごとにHTMLを生成する必要があるため、処理に時間がかかる。
    -   サーバーの負荷が高い（サーバーコストの増大）。
-   **適した用途**: 動的なデータ（ユーザー情報など）を頻繁に表示する必要がある、SEOが重要なページ。ECサイトの商品詳細ページ、ニュースサイトの記事ページなど。

#### 3. SSG (Static Site Generation)

-   **仕組み**: 
    1.  アプリケーションを**ビルドする時点**で、すべてのページのHTMLを事前に生成しておく。
    2.  サーバーは、リクエストが来たら、すでに生成済みの静的なHTMLファイルを返すだけ。
-   **誰が**: **ビルドサーバー**
-   **いつ**: **ビルド時**
-   **長所**:
    -   **パフォーマンスが最速**。TTFBもFCPも非常に速い。リクエスト時に計算が不要で、CDNにキャッシュすることも容易。
    -   **SEOに強い**。
    -   サーバー負荷がほぼゼロ。
-   **短所**:
    -   **コンテンツの更新に、サイト全体の再ビルドが必要**。データが頻繁に変わるサイトには向かない。
    -   動的なコンテンツ（パーソナライズなど）を扱うのが難しい。
-   **適した用途**: ブログ、ドキュメントサイト、マーケティング用のランディングページなど、コンテンツの更新が比較的少なく、パフォーマンスとSEOが最優先されるサイト。

#### 4. ISR (Incremental Static Regeneration)

-   **仕組み**: SSGとSSRのハイブリッド。Next.jsが導入した画期的なアプローチ。
    1.  基本はSSGと同じく、ビルド時にHTMLを生成する。
    2.  ただし、一定時間（例: 60秒）が経過した後の最初のリクエストに対して、サーバーは**バックグラウンドでページの再生成**を試みる。
    3.  そのリクエストに対しては、まず古い（キャッシュされた）HTMLを返しつつ、再生成が完了したら、次以降のリクエストには新しいHTMLを返すようになる。
-   **誰が**: **サーバー**
-   **いつ**: **ビルド時 + 一定時間ごとのリクエスト時（バックグラウンドで）**
-   **長所**:
    -   **SSGの高速なパフォーマンス**を享受しつつ、**定期的にコンテンツを自動更新**できる。
    -   SSRのようにリクエストごとにサーバーをブロックすることがないため、TTFBが安定して速い。
    -   サイト全体の再ビルドが不要。
-   **短所**:
    -   一定時間は、古いコンテンツが表示される可能性がある。
-   **適した用途**: 多くのSSGのユースケースをカバーしつつ、ある程度の鮮度が求められるサイト。ニュースサイトのトップページ、ECサイトの製品一覧ページなど。

--- 

### ⚖️ 選択のためのフローチャート

どのレンダリング戦略を選ぶべきか、以下のフローチャートを参考に考えてみましょう。

```mermaid
graph TD
    A[Start] --> B{SEOは重要か？};
    B -->|No| C[CSR (管理画面など)];
    B -->|Yes| D{ページはリクエストごとに動的に変わる必要があるか？（例: ユーザー情報）};
    D -->|Yes| E[SSR (マイページなど)];
    D -->|No| F{コンテンツの更新頻度は高いか？};
    F -->|No| G[SSG (ブログ、ドキュメント)];
    F -->|Yes| H{最新のデータが常に必須か？};
    H -->|Yes| E;
    H -->|No| I[ISR (ニュースサイト、EC一覧)];
```

--- 

✨ **まとめ**

| 戦略 | HTML生成のタイミング | パフォーマンス | SEO | サーバー負荷 | おすすめの用途 |
|:---|:---|:---|:---|:---:|:---|
| **CSR** | 実行時（クライアント） | 遅い | 弱い | 低 | 管理画面、ダッシュボード |
| **SSR** | リクエストごと（サーバー） | FCPは速いがTTFBは遅い | 強い | 高 | マイページ、動的コンテンツ |
| **SSG** | ビルド時 | **最速** | 強い | ほぼゼロ | ブログ、ドキュメント、LP |
| **ISR** | ビルド時 + 定期的な再生成 | ほぼSSG並みに速い | 強い | 低 | ニュースサイト、ECサイト |

現代のWeb開発、特にNext.jsでは、**デフォルトでSSG/ISRを目指し、どうしても必要なページだけをSSRやCSRにする**というハイブリッドなアプローチが最も強力です。ページの特性を一つ一つ見極め、最適なレンダリング戦略を適用することが、「最強のフロントエンド」への道筋となります。

📝 **学習のポイント**

-   [ ] あなたが普段よく使うWebサービス（例: Twitter, Amazon, GitHub）の特定のページは、どのレンダリング戦略が使われている（または最適だ）と思いますか？ その理由も合わせて考えてみましょう。
-   [ ] Next.jsの`getStaticProps`, `getServerSideProps`, そしてクライアントサイドでのデータ取得（SWRやReact Queryなど）は、それぞれSSG, SSR, CSRとどのように対応しているか、関係性を整理してください。
-   [ ] ISRの`revalidate`オプションの値を`60`に設定した場合、60秒が経過した瞬間にすべてのユーザーに対してページが再生成されるのでしょうか？ それとも、挙動は異なりますか？ ISRの「stale-while-revalidate」というキャッシュ戦略について詳しく調べてみましょう。
