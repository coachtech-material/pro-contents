# 11-1-3: Vitestの基本

## 🎯 このセクションで学ぶこと

-   Vitestの概要と特徴（Viteネイティブ、高速、Jest互換）を理解する
-   Vitestの基本的なAPI（`describe`, `it`, `expect`）の使い方を習得する
-   簡単な純粋関数のテストを実際に書いて、実行する方法を学ぶ

## 導入

[Vitest](https://vitest.dev/)は、Viteベースの高速なテストフレームワークです。Viteを利用するプロジェクト（このチュートリアルで作成するNext.jsプロジェクトも含む）と非常に相性が良く、設定もシンプルです。

### Vitestの主な特徴

-   **高速な実行**: ViteのHMR（ホットモジュールリプレイスメント）の仕組みを利用して、変更されたテストだけを即座に再実行します。開発中のフィードバックループが非常に高速です。
-   **シンプルな設定**: Viteの設定ファイル（`vite.config.ts`）を共有するため、テストのための複雑な設定が不要です。
-   **Jest互換のAPI**: 最も広く使われているテストフレームワークである[Jest](https://jestjs.io/)と互換性のあるAPIを提供しています。`describe`, `it`, `expect`といったおなじみの構文でテストを書くことができ、Jestからの移行も容易です。

## Vitestの基本API

Vitestでテストを書く際には、主に3つのグローバル関数を利用します。これらの関数は、テストファイル内で`import`文なしに利用できます。

1.  `describe(name, factory)`
    -   複数の関連するテストをグループ化するために使います。
    -   `name`には、テストグループの分かりやすい名前（例: 「`useCounter`フックのテスト」）を文字列で指定します。
    -   `factory`には、実際のテストコードを含む関数を指定します。

2.  `it(name, factory)` または `test(name, factory)`
    -   個々のテストケースを定義します。`it`と`test`はエイリアスであり、機能は全く同じです。どちらを使うかは好みの問題ですが、一般的に「It should ...（それは〜するべきである）」という英文のように読めることから`it`が好まれる傾向があります。
    -   `name`には、そのテストケースが何を検証しているのか（仕様）を具体的に記述します。（例: 「`increment`を呼ぶとカウントが1増える」）

3.  `expect(value)`
    -   アサーション（assertion）を開始するために使います。「アサーション」とは、「値が期待通りであること」を表明するコードです。
    -   `expect`に検証したい値（`value`）を渡すと、マッチャー（matcher）メソッドを持つオブジェクトが返されます。

### マッチャー（Matcher）とは？

マッチャーは、`expect`で渡された値が期待値とどのように一致するかを検証するためのメソッドです。よく使われるマッチャーには以下のようなものがあります。

-   `.toBe(expected)`: プリミティブ値（数値、文字列、真偽値など）が厳密に等しいか（`===`）を検証します。
-   `.toEqual(expected)`: オブジェクトや配列が、再帰的に見て同じ値を持つかを検証します。
-   `.toBeTruthy()`: 値が`true`であることを検証します。
-   `.toBeFalsy()`: 値が`false`であることを検証します。
-   `.toContain(item)`: 配列や文字列に特定の値が含まれているかを検証します。
-   `.toThrow()`: 関数が例外をスローするかを検証します。

その他にも多くのマッチャーが存在します。詳しくは[Vitestの公式ドキュメント](https://vitest.dev/api/expect.html)を参照してください。

## 実際にテストを書いてみよう

それでは、簡単な純粋関数のテストを書いてみましょう。

#### ステップ1: テスト対象の関数の作成

`src/utils/math.ts`というファイルを作成し、2つの数値を足し合わせる簡単な関数を定義します。

```typescript
// src/utils/math.ts

export const add = (a: number, b: number): number => {
  return a + b;
};
```

#### ステップ2: テストファイルの作成

Vitestは、`.test.ts`または`.spec.ts`という接尾辞を持つファイルをテストファイルとして自動的に認識します。一般的に、テスト対象のファイルと同じ階層にテストファイルを置くのが管理しやすいため推奨されます。

`src/utils/math.test.ts`を作成し、以下のテストコードを記述します。

```typescript
// src/utils/math.test.ts

import { describe, it, expect } from "vitest";
import { add } from "./math";

// `add`関数に関するテストをグループ化
describe("add", () => {
  // テストケース1: 正の数の足し算
  it("2つの正の数を正しく足し算できる", () => {
    // 期待値の表明: add(1, 2)の結果は3であるべき
    expect(add(1, 2)).toBe(3);
  });

  // テストケース2: 負の数を含む足し算
  it("負の数を含む足し算が正しくできる", () => {
    expect(add(-1, 5)).toBe(4);
  });

  // テストケース3: ゼロとの足し算
  it("ゼロを足しても値が変わらない", () => {
    expect(add(10, 0)).toBe(10);
  });
});
```

**コードのポイント:**

-   `describe`で`add`関数に関するテストをまとめています。
-   `it`で3つの異なるテストケース（仕様）を定義しています。テストケース名は、そのテストが何を検証しているのかが明確に分かるように記述するのが重要です。
-   `expect(...).toBe(...)`を使って、`add`関数の実行結果が期待通りであるかを検証しています。

#### ステップ3: テストの実行

`package.json`にテスト実行用のスクリプトを追加します。

```json
// package.json
{
  ...
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "test": "vitest" // この行を追加
  },
  ...
}
```

ターミナルで以下のコマンドを実行します。

```bash
npm test
```

すると、Vitestが起動し、プロジェクト内のテストファイルを実行します。すべてのテストが成功すれば、以下のような出力が表示されます。

```
 ✓ src/utils/math.test.ts (3)

 Test Files  1 passed (1)
      Tests  3 passed (3)
   Start at  10:00:00
   Duration  123ms (transform 45ms, setup 0ms, collect 12ms, tests 1ms)


 PASS  Waiting for file changes...
       press h to show help, press q to quit
```

`PASS`と表示されれば成功です！Vitestはデフォルトでウォッチモードで起動するため、ファイルの変更を監視し続けます。`q`キーを押すと終了します。

## ✨ まとめ

-   VitestはViteベースの高速なテストフレームワークである。
-   `describe`でテストをグループ化し、`it`で個々のテストケースを定義する。
-   `expect`とマッチャーを使って、値が期待通りであるかを検証（アサーション）する。
-   テストファイルは`.test.ts`または`.spec.ts`という名前にし、`npm test`で実行する。

これで、純粋関数のユニットテストを書く準備が整いました。次のハンズオンでは、この知識を使ってカスタムフックのテスト作成に挑戦します。
