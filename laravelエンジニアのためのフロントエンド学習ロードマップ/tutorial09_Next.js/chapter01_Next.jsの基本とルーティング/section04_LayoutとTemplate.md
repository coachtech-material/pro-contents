# Tutorial 9: Next.js

## Chapter 1: Next.jsの基本とルーティング

### Section 4: LayoutとTemplate

🎯 **このセクションで学ぶこと**

-   `layout.tsx`が、複数のページで共通のUIを共有するための仕組みであることを理解する。
-   ルートセグメントごとにネストされたレイアウトを作成し、特定のセクション（例: `/dashboard/*`）だけで共通のサイドバーを表示する方法を習得する。
-   `layout.tsx`と`template.tsx`の主な違い（Stateを保持するかどうか）を説明できるようになる。

--- 

### イントロダクション：UIの共通化

多くのWebアプリケーションでは、複数のページで共通のUI要素（ヘッダー、フッター、サイドバーなど）を共有します。Next.jsのApp Routerでは、この共通UIを**レイアウト**という仕組みでエレガントに実現します。

レイアウトは、`layout.tsx`という特別な名前のファイルで定義します。このファイルは、同じ階層やそれより下の階層にある`page.tsx`を子要素として受け取り、共通のUIでラップします。

--- 

### 🚀 ルートレイアウト (`src/app/layout.tsx`)

プロジェクト作成時に自動で生成される`src/app/layout.tsx`は、アプリケーション全体の**ルートレイアウト**です。すべてのページがこのレイアウトによってラップされます。

```tsx
// src/app/layout.tsx
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

// `children` propsを受け取る
export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body className={inter.className}>
        {/* このchildrenに、各ページのpage.tsxが入る */}
        {children}
      </body>
    </html>
  );
}
```

-   **`children` Props**: レイアウトコンポーネントは、`children`という特別なPropsを受け取ります。この`children`に、実際のページコンポーネント（`page.tsx`）が渡されます。
-   **HTMLの骨格**: `<html>`や`<body>`といったタグは、このルートレイアウトに一度だけ記述します。

#### 例：共通ヘッダーの追加

すべてのページに共通のヘッダーを追加してみましょう。

1.  `src/components`フォルダに`Header.tsx`を作成します。

```tsx
// src/components/Header.tsx
import Link from "next/link";

export default function Header() {
  return (
    <header style={{ backgroundColor: "#eee", padding: "1rem" }}>
      <nav style={{ display: "flex", gap: "1rem" }}>
        <Link href="/">Home</Link>
        <Link href="/about">About</Link>
        <Link href="/dashboard">Dashboard</Link>
      </nav>
    </header>
  );
}
```

2.  `src/app/layout.tsx`で`Header`コンポーネントをインポートし、`children`の上に配置します。

```tsx
// src/app/layout.tsx
import Header from "@/components/Header"; // Headerをインポート
// ...

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body>
        <Header /> {/* Headerを配置 */}
        <main>{children}</main> {/* childrenをmainタグで囲むとより良い */}
      </body>
    </html>
  );
}
```

これで、どのページにアクセスしても共通のヘッダーが表示されるようになります。

--- 

### ⚙️ ネストされたレイアウト

レイアウトは、ルートセグメント（フォルダ）ごとに定義できます。これにより、特定のセクションだけで共通のUIを適用する、**ネストされたレイアウト**を構築できます。

#### 例：ダッシュボード用のレイアウト作成

`/dashboard`とその配下のページ（例: `/dashboard/settings`）だけで表示されるサイドバーを持つ、専用のレイアウトを作成してみましょう。

1.  `src/app/dashboard`フォルダを作成し、その中に`page.tsx`と`layout.tsx`の両方を作成します。

```
src/
└── app/
    └── dashboard/
        ├── layout.tsx      // ダッシュボード用のレイアウト
        └── page.tsx        // /dashboard のページ
```

2.  `src/app/dashboard/layout.tsx`を編集します。

このレイアウトも`children` Propsを受け取ります。この`children`には、同じ階層の`page.tsx`（`/dashboard`）や、さらに下の階層のページ（`/dashboard/settings`など）が入ります。

```tsx
// src/app/dashboard/layout.tsx

export default function DashboardLayout({ children }: { children: React.ReactNode }) {
  return (
    <section style={{ display: "flex" }}>
      <aside style={{ width: "200px", borderRight: "1px solid #ccc", padding: "1rem" }}>
        <h2>Dashboard</h2>
        <ul>
          <li><a href="/dashboard">Overview</a></li>
          <li><a href="/dashboard/settings">Settings</a></li>
        </ul>
      </aside>
      <div style={{ padding: "1rem" }}>{children}</div>
    </section>
  );
}
```

3.  `src/app/dashboard/page.tsx`を作成します。

```tsx
// src/app/dashboard/page.tsx
export default function DashboardPage() {
  return <h1>Dashboard Overview</h1>;
}
```

これで、`/dashboard`にアクセスすると、ルートレイアウト（ヘッダー）とダッシュボードレイアウト（サイドバー）の両方が適用されたページが表示されます。一方、`/`や`/about`にアクセスしても、サイドバーは表示されません。

--- 

### 🤔 `layout.tsx` vs `template.tsx`

App Routerには、レイアウトと非常によく似た`template.tsx`というファイルもあります。両者の違いは、**状態（State）の扱い方**にあります。

-   **`layout.tsx`**: **Stateを保持する**
    -   レイアウトは、ページ遷移後もアンマウントされません。そのため、レイアウト内で定義された`useState`や`useContext`の状態は、ページを移動しても**保持されます**。
    -   例: 共通のサイドバーの開閉状態など。

-   **`template.tsx`**: **Stateを保持しない**
    -   テンプレートは、ページ遷移のたびに**毎回新しいインスタンスが作成**され、アンマウント・再マウントされます。そのため、Stateは**リセットされます**。
    -   主な用途:
        -   ページ遷移時に`useEffect`（依存配列`[]`）を再実行させたい場合。
        -   ページ遷移時にCSSアニメーション（enter/exitアニメーション）をトリガーしたい場合。

ほとんどの場合、`layout.tsx`を使用すれば問題ありません。`template.tsx`は、上記のような特定の要件がある場合にのみ使用する、より高度な機能と覚えておきましょう。

--- 

✨ **まとめ**

-   `layout.tsx`ファイルは、同じ階層やそれ以下のページの共通UIを定義する。
-   `src/app/layout.tsx`は、アプリケーション全体の**ルートレイアウト**である。
-   フォルダごとに`layout.tsx`を配置することで、**ネストされたレイアウト**を構築できる。
-   `layout.tsx`はページ遷移後もStateを保持するが、`template.tsx`は遷移のたびにStateをリセットする。

📝 **学習のポイント**

-   [ ] ブログアプリケーションを考えます。`/posts/[id]`という記事詳細ページと、`/posts/new`という新規投稿ページで、共通の「記事エリア用レイアウト」（例えば、特定の幅を持つコンテナ）を適用するには、どのディレクトリに`layout.tsx`を置くべきでしょうか？
-   [ ] `layout.tsx`の中で`fetch`を使ってデータを取得することは可能でしょうか？ もし可能なら、そのデータはいつ、どのように子コンポーネントに渡されるでしょうか？（ヒント: サーバーコンポーネントの特性）
-   [ ] `template.tsx`を使って、ページが切り替わるたびにフェードインするアニメーションを実装するには、どのようなライブラリ（例: `framer-motion`）と組み合わせ、どのように`useEffect`を使えばよいか考えてみましょう。
