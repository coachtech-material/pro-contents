# 9-3-4: パフォーマンス最適化

## 🎯 この章で学ぶこと

- Next.jsアプリケーションのパフォーマンスを測定し、ボトルネックを特定する方法を学ぶ。
- Core Web Vitalsの重要性と、それを改善するための具体的な手法を理解する。
- Next.jsが提供する組み込みコンポーネント（`Image`, `Link`, `Script`）を活用した最適化方法をマスターする。
- 動的インポート（`next/dynamic`）によるJavaScriptバンドルサイズの削減方法を学ぶ。

## はじめに

ここまでの章で、Next.jsのレンダリングとキャッシュの仕組みを学びました。これらの機能を理解することは、パフォーマンスの高いアプリケーションを構築するための第一歩です。しかし、それだけでは十分ではありません。実際の開発では、アプリケーションのパフォーマンスを継続的に監視し、ボトルネックを特定して改善していく必要があります。

この章では、Next.jsアプリケーションのパフォーマンスをさらに一段階引き上げるための、より実践的な最適化テクニックに焦点を当てます。

## 1. パフォーマンスの測定とCore Web Vitals

最適化の第一歩は、現状を正確に把握することです。Googleが提唱する**Core Web Vitals**は、ユーザー体験の質を測定するための重要な指標群であり、SEOのランキング要因にもなっています。[1]

-   **LCP (Largest Contentful Paint)**: ページの主要コンテンツが描画されるまでの時間。2.5秒未満が理想。
-   **FID (First Input Delay)**: ユーザーが最初にインタラクション（クリックなど）を行ってから、ブラウザが応答するまでの時間。100ミリ秒未満が理想。（※現在はINPに移行）
-   **CLS (Cumulative Layout Shift)**: ページの読み込み中にレイアウトがどれだけズレるかを示す指標。0.1未満が理想。
-   **INP (Interaction to Next Paint)**: FIDに代わる新しい指標。ユーザーのインタラクションから次のフレームが描画されるまでの時間。200ミリ秒未満が理想。

これらの指標は、Vercel AnalyticsやGoogleのPageSpeed Insightsといったツールで簡単に測定できます。

## 2. Next.js組み込みコンポーネントによる最適化

Next.jsは、一般的なパフォーマンスの問題を解決するための最適化済みコンポーネントを標準で提供しています。

### `next/image`

`<img>`タグの代わりに`<Image>`コンポーネントを使うことで、画像に関する多くの最適化が自動的に行われます。[2]

-   **自動リサイズ**: デバイスの画面サイズに合わせて、適切なサイズの画像を自動的に生成・配信。
-   **フォーマットの最適化**: ブラウザが対応していれば、WebPのようなモダンな画像フォーマットに自動で変換。
-   **遅延読み込み (Lazy Loading)**: デフォルトで有効。画像がビューポートに入るまで読み込みを遅延させ、初期ロード時間を短縮。
-   **CLSの防止**: `width`と`height`を事前に指定することで、画像の表示領域を確保し、レイアウトシフトを防ぐ。

```jsx
import Image from 'next/image';
import profilePic from '../public/me.png';

<Image
  src={profilePic} // publicディレクトリからの画像、またはimportした画像
  alt="Picture of the author"
  width={500} // CLS防止のために必須
  height={500} // CLS防止のために必須
  priority // LCPになる可能性が高い画像にはpriority属性を付けて優先的に読み込む
/>
```

### `next/link`

`<a>`タグの代わりに`<Link>`コンポーネントを使うことで、クライアントサイドでの高速なページ遷移が実現されます。

-   **プリフェッチ**: ビューポートに入った`<Link>`の遷移先ページをバックグラウンドで自動的にプリフェッチします。これにより、ユーザーがリンクをクリックした際には、すでにページのデータ（RSC Payload）が読み込み済みになっており、瞬時にページが切り替わります。

```jsx
import Link from 'next/link';

<Link href="/dashboard">Dashboard</Link>
```

### `next/script`

`<script>`タグの代わりに`<Script>`コンポーネントを使うことで、サードパーティのスクリプト（Google Analyticsなど）の読み込みを効率的に管理できます。

-   **読み込み戦略の指定 (`strategy`)**: スクリプトを読み込むタイミングを制御できます。
    -   `beforeInteractive`: ページがインタラクティブになる前に実行。
    -   `afterInteractive` (デフォルト): ページがインタラクティブになった後に実行。ほとんどのスクリプトはこれでOK。
    -   `lazyOnload`: ブラウザがアイドル状態になったときに実行。

```jsx
import Script from 'next/script';

<Script src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID" strategy="afterInteractive" />
```

## 3. JavaScriptバンドルサイズの削減

ページのインタラクティブ性を損なう大きな原因の一つが、巨大なJavaScriptバンドルです。特に、初回ロード時に必要ないコンポーネントやライブラリまで読み込んでしまうと、パフォーマンスは著しく低下します。

### 動的インポート (`next/dynamic`)

`next/dynamic`を使うと、コンポーネントを動的にインポートし、必要なタイミングで初めて読み込むように設定できます。これはコード分割（Code Splitting）の強力な手法です。[3]

例えば、ボタンをクリックして初めて表示されるモーダルダイアログや、ページの下の方にあるフッターなど、初回表示に必須でないコンポーネントに適用すると効果的です。

```jsx
import { useState } from 'react';
import dynamic from 'next/dynamic';

// Modalコンポーネントを動的にインポート
// このコンポーネントのコードは、初期JSバンドルから分離される
const HeavyModal = dynamic(() => import('../components/HeavyModal'), {
  loading: () => <p>Loading...</p>, // ロード中に表示するUI
  ssr: false, // サーバーサイドではレンダリングしない
});

export default function Home() {
  const [showModal, setShowModal] = useState(false);

  return (
    <div>
      <button onClick={() => setShowModal(true)}>Show Modal</button>
      {showModal && <HeavyModal onClose={() => setShowModal(false)} />}
    </div>
  );
}
```

`ssr: false`オプションは、そのコンポーネントが`window`オブジェクトなどブラウザ固有のAPIに依存している場合に便利です。

## ✨ まとめ

-   パフォーマンス最適化は、まず**測定**から始まる。Core Web Vitalsを意識し、ボトルネックを特定する。
-   Next.jsが提供する**`<Image>`, `<Link>`, `<Script>`**コンポーネントを積極的に利用することで、多くの一般的なパフォーマンス問題が自動的に解決される。
-   `<Image>`は画像の最適化、`<Link>`は高速なナビゲーション、`<Script>`はサードパーティスクリプトの効率的な読み込みを実現する。
-   `next/dynamic`による**動的インポート**は、JavaScriptバンドルサイズを削減し、初期ロード時間を短縮するための強力な武器である。
-   これらのテクニックを組み合わせ、キャッシュ戦略と合わせて総合的に適用することで、ユーザー体験を飛躍的に向上させることができる。

---

## 参考文献

[1] web.dev. (n.d.). *Core Web Vitals*. Retrieved from https://web.dev/vitals/
[2] Next.js Documentation. (n.d.). *Image Optimization*. Retrieved from https://nextjs.org/docs/app/building-your-application/optimizing/images
[3] Next.js Documentation. (n.d.). *Dynamic Imports*. Retrieved from https://nextjs.org/docs/app/building-your-application/optimizing/lazy-loading
