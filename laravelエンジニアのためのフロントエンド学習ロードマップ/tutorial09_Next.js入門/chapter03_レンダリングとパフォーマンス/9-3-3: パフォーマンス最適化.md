# 9-3-3: パフォーマンス最適化

## 🎯 このセクションで学ぶこと

-   Webパフォーマンスの重要性と主要な指標（Core Web Vitals）を理解する
-   Next.jsが提供する組み込みのパフォーマンス最適化機能を学ぶ
-   `next/image`コンポーネントを使った画像の自動最適化の方法を習得する
-   `next/font`を使ったWebフォントの最適化とレイアウトシフト防止の方法を習得する
-   Dynamic Imports (`next/dynamic`) を使ったコンポーネントの遅延読み込みとコード分割の方法を学ぶ

## 導入

Next.jsは、デフォルトで高いパフォーマンスを発揮するように設計されていますが、アプリケーションが成長するにつれて、パフォーマンスのボトルネックが発生することがあります。特に、画像、フォント、サードパーティのJavaScriptは、ページの読み込み速度に大きな影響を与える三大要因です。

幸いなことに、Next.jsはこれらの一般的なパフォーマンス問題を解決するための、強力で使いやすい組み込みコンポーネントと機能を提供しています。このセクションでは、Next.jsアプリケーションのパフォーマンスをさらに向上させるための、以下の3つの重要なテクニックに焦点を当てます。

1.  **画像最適化 (`next/image`)**: 画像のサイズを自動的に最適化し、最新の画像フォーマットで配信する。
2.  **フォント最適化 (`next/font`)**: Webフォントの読み込みを効率化し、レイアウトシフトを防ぐ。
3.  **動的インポート (`next/dynamic`)**: 初期表示に不要なコンポーネントを遅延読み込みし、JavaScriptのバンドルサイズを削減する。

これらの機能を活用することで、Core Web Vitals（Googleが提唱するWeb体験の品質指標）を改善し、ユーザー体験とSEOの両方を向上させることができます。

## 詳細解説

### 1. 画像最適化: `<Image>` コンポーネント

Webサイトで最も重いアセットは画像であることが多いです。巨大な画像をそのまま配信すると、ページの読み込みが著しく遅くなります。Next.jsの`<Image>`コンポーネント（`next/image`からインポート）は、この問題を解決するためのオールインワンソリューションです。

標準の`<img>`タグの代わりに`<Image>`コンポーネントを使うだけで、Next.jsは自動的に以下の最適化を行います。

-   **サイズ最適化**: デバイスのビューポートに合わせて、適切なサイズの画像を自動的に生成・配信します。巨大な画像をモバイルデバイスに送るような無駄がなくなります。
-   **フォーマット最適化**: ブラウザが対応していれば、WebPやAVIFのような次世代の軽量な画像フォーマットに自動的に変換して配信します。
-   **遅延読み込み (Lazy Loading)**: デフォルトで、ビューポートに入るまで画像の読み込みを遅延させます。初期表示に関係ない画像の読み込みを後回しにすることで、ページの初期表示速度を向上させます。
-   **レイアウトシフトの防止**: 画像の`width`と`height`を必須とすることで、画像の読み込み中に発生するガタつき（Cumulative Layout Shift, CLS）を自動的に防ぎます。

**使い方:**

```tsx
import Image from "next/image";
import profilePic from "../public/me.png"; // ローカル画像はimportする

export default function MyPage() {
  return (
    <div>
      {/* ローカル画像の場合 */}
      <Image
        src={profilePic} // importしたオブジェクトを渡す
        alt="Picture of the author"
        // widthとheightは必須 (インポートした静的画像の場合は自動で設定される)
        // placeholder="blur" // オプション: ブラーアップ効果
      />

      {/* 外部画像の場合 */}
      <Image
        src="https://images.unsplash.com/photo-15..."
        alt="A beautiful landscape"
        width={500} // 必須
        height={300} // 必須
      />
    </div>
  );
}
```

`<img>`を`<Image>`に置き換えるだけで、これだけの最適化が自動的に行われるのは非常に強力です。

### 2. フォント最適化: `next/font`

Webフォント（特にGoogle Fonts）は手軽に使えますが、外部からフォントファイルをダウンロードするため、レンダリングをブロックしたり、フォントの読み込み前後でテキストのスタイルが一瞬変わる（FOUT）/非表示になる（FOIT）、レイアウトがずれる（CLS）といった問題を引き起こす可能性があります。

`next/font`は、この問題を解決します。フォントファイルをビルド時にダウンロードし、他の静的アセットと一緒にセルフホストすることで、プライバシーとパフォーマンスを向上させます。

**使い方 (Google Fonts):**

```tsx
// app/layout.tsx
import { Inter, Noto_Sans_JP } from "next/font/google";

// フォント設定を定義
const inter = Inter({ subsets: ["latin"] });
const notoSansJP = Noto_Sans_JP({
  subsets: ["latin"],
  weight: ["400", "700"],
  display: "swap",
});

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    // <html>タグや<body>タグにclassNameを適用する
    <html lang="ja" className={notoSansJP.className}>
      <body>{children}</body>
    </html>
  );
}
```

これだけで、Next.jsは以下の最適化を行います。

-   **自動セルフホスティング**: ビルド時にGoogle Fontsからフォントファイルをダウンロードし、アプリケーションと一緒に配信します。これにより、ブラウザがGoogleのサーバーにリクエストを送る必要がなくなり、プライバシーが保護され、パフォーマンスも安定します。
-   **レイアウトシフトの防止**: フォントのメトリクス（サイズ情報）に基づいて、フォールバックフォントのスタイルを自動調整するCSSを生成します。これにより、カスタムフォントの読み込み前後でのレイアウトのズレ（CLS）がゼロになります。

### 3. 動的インポート: `next/dynamic`

アプリケーションが大きくなると、JavaScriptのバンドルサイズも肥大化し、初期読み込みに時間がかかるようになります。しかし、すべてのコンポーネントがページの初期表示に必要というわけではありません。

`next/dynamic`を使うと、特定のコンポーネントを初期バンドルから除外し、必要になったタイミング（例: クリックされた時、ビューポートに入った時）で動的に（遅延して）読み込むことができます。

**使い方:**

例えば、クリックしないと表示されないモーダルコンポーネントや、ページのフッター近くにあるような重いコンポーネントが対象になります。

```tsx
import { useState } from "react";
import dynamic from "next/dynamic";

// HeavyComponentを動的にインポート
const HeavyComponent = dynamic(() => import("../components/HeavyComponent"), {
  // オプション: 読み込み中に表示するコンポーネント
  loading: () => <p>Loading...</p>,
  // オプション: サーバーサイドレンダリングを無効化
  ssr: false,
});

export default function MyPage() {
  const [show, setShow] = useState(false);

  return (
    <div>
      <button onClick={() => setShow(true)}>Show Heavy Component</button>
      {/* showがtrueになった時に初めてHeavyComponentのJSが読み込まれる */}
      {show && <HeavyComponent />}
    </div>
  );
}
```

-   **コード分割**: `HeavyComponent`とその依存関係は、別のJavaScriptファイル（チャンク）に分割され、初期読み込み時にはダウンロードされません。
-   **遅延読み込み**: `show`が`true`になるまで、このチャンクは読み込まれません。これにより、初期ページのJavaScriptサイズが削減され、インタラクティブになるまでの時間（TTI）が短縮されます。

## ✨ まとめ

-   Next.jsは、Webパフォーマンスを向上させるための強力な組み込み機能を提供している。
-   `<img>`タグを`next/image`の`<Image>`コンポーネントに置き換えるだけで、画像のサイズ、フォーマット、読み込みタイミングが自動的に最適化され、レイアウトシフトも防止できる。
-   `next/font`を使うことで、Webフォントを簡単にセルフホストでき、パフォーマンスとプライバシーを向上させつつ、フォントによるレイアウトシフトをなくすことができる。
-   `next/dynamic`を使うことで、コンポーネント単位でコード分割と遅延読み込みを実装でき、初期JavaScriptバンドルサイズを削減して、ページの表示速度とインタラクティブ性を高めることができる。
-   これらの機能を積極的に活用することが、高速でユーザー体験の良いNext.jsアプリケーションを構築するための鍵となる。
