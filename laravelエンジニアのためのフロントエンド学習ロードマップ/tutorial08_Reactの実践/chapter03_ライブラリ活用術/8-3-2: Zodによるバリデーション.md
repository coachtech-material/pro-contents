# 8-3-2: Zodによるバリデーション

## 🎯 このセクションで学ぶこと

- バリデーションスキーマライブラリ`Zod`の基本的な使い方を理解する
- `Zod`を使って、フォームのバリデーションルールをオブジェクト（スキーマ）として定義する方法を学ぶ
- `Zod`のスキーマからTypeScriptの型を自動的に推論させる方法を習得する
- `React Hook Form`と`Zod`を連携させ、より宣言的で型安全なフォームバリデーションを実装する方法を学ぶ

## 導入

前のセクションでは、`React Hook Form`の`register`メソッドの第二引数にバリデーションルールを記述しました。これは手軽ですが、フォームが複雑になるにつれて、いくつかの課題が見えてきます。

-   **型の重複**: フォームのデータ型（`interface`）と、バリデーションルールを別々に定義する必要があり、両者の同期が取れなくなる可能性がある。
-   **再利用性の低さ**: バリデーションルールがコンポーネント内に記述されるため、同じルールを別のフォームで再利用するのが難しい。
-   **複雑なルールの記述**: 「パスワードと確認用パスワードが一致するか」といった、複数のフィールドにまたがる相関バリデーションを記述するのが煩雑。

これらの課題を解決するのが、**`Zod`** のような「スキーマベース」のバリデーションライブラリです。

`Zod`は、TypeScriptファーストで設計されたバリデーションライブラリで、「**スキーマを一度定義すれば、バリデーションと型の両方を得られる**」という強力な特徴を持っています。これにより、型の定義とバリデーションルールを一元管理でき、コードの信頼性とメンテナンス性が飛躍的に向上します。

## 詳細解説

### 🔑 Zodの基本

`Zod`では、データの構造とバリデーションルールを「スキーマ」と呼ばれるオブジェクトとして定義します。`z.string()`や`z.number()`といったメソッドをチェーンさせることで、直感的にスキーマを構築できます。

```bash
npm install zod
```

```typescript
import { z } from "zod";

// ユーザー登録フォームのスキーマを定義
const UserSchema = z.object({
  username: z.string().min(3, "Username must be at least 3 characters"),
  email: z.string().email("Invalid email address"),
  age: z.number().min(18, "You must be at least 18"),
});
```

この`UserSchema`は、単なるバリデーションルールだけではありません。`Zod`の最も強力な機能は、このスキーマからTypeScriptの型を**推論**できることです。

```typescript
// スキーマから型を生成
type User = z.infer<typeof UserSchema>;

// User型は以下のようになる
// type User = {
//   username: string;
//   email: string;
//   age: number;
// }
```

`z.infer`を使うことで、スキーマ定義と型の定義を完全に同期させることができます。バリデーションルールを変更すれば、型も自動的に更新されるため、二重管理の手間がなくなり、ヒューマンエラーを防ぎます。

### React Hook Formとの連携

`React Hook Form`は、`Zod`のような外部のバリデーションライブラリと簡単に連携するための公式パッケージ`@hookform/resolvers`を提供しています。

```bash
npm install @hookform/resolvers
```

このリゾルバーを使うことで、`useForm`に`Zod`のスキーマを直接渡すことができます。

### 実装例

前のセクションで作成したフォームを、`Zod`を使ってリファクタリングしてみましょう。

```tsx
import React from 'react';
import { useForm, SubmitHandler } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

// 1. Zodスキーマを定義
const FormSchema = z.object({
  firstName: z.string().min(1, 'First name is required').max(20),
  lastName: z.string().regex(/^[A-Za-z]+$/i, 'Last name must be alphabet'),
  age: z.coerce.number().min(18, 'Age must be between 18 and 99').max(99),
});

// 2. スキーマから型を推論
type IFormInput = z.infer<typeof FormSchema>;

function App() {
  const { 
    register, 
    handleSubmit, 
    formState: { errors } 
  } = useForm<IFormInput>({
    // 3. resolverをuseFormに設定
    resolver: zodResolver(FormSchema),
  });

  const onSubmit: SubmitHandler<IFormInput> = data => {
    console.log(data);
    alert(`Hello, ${data.firstName} ${data.lastName}!`);
  };

  return (
    // 4. エラーメッセージをZodから取得
    <form onSubmit={handleSubmit(onSubmit)}>
      <div>
        <label>First Name</label>
        <input {...register("firstName")} />
        {errors.firstName && <p style={{ color: 'red' }}>{errors.firstName.message}</p>}
      </div>

      <div>
        <label>Last Name</label>
        <input {...register("lastName")} />
        {errors.lastName && <p style={{ color: 'red' }}>{errors.lastName.message}</p>}
      </div>

      <div>
        <label>Age</label>
        <input type="number" {...register("age")} />
        {errors.age && <p style={{ color: 'red' }}>{errors.age.message}</p>}
      </div>

      <button type="submit">Submit</button>
    </form>
  );
}

export default App;
```

#### コードのポイント

1.  **スキーマ定義**: バリデーションルールを`z.object`を使って一箇所にまとめます。`min(1, '...')`のように、第二引数にカスタムエラーメッセージを指定できます。
2.  **`z.infer`**: スキーマから`IFormInput`型を生成します。これにより、`interface`を手で書く必要がなくなりました。
3.  **`zodResolver`**: `useForm`の`resolver`オプションに`zodResolver(FormSchema)`を渡すことで、`React Hook Form`がバリデーションに`Zod`スキーマを使用するようになります。これにより、`register`メソッドにバリデーションルールを書く必要がなくなりました。
4.  **エラーメッセージ**: `errors.firstName?.message`のように、`Zod`スキーマで定義したエラーメッセージを直接表示できます。`?`（オプショナルチェイニング）を付けておくと、エラーがない場合に`undefined`となり、安全にプロパティにアクセスできます。
5.  **`z.coerce.number()`**: HTMLの`<input type="number">`は、値が文字列として扱われることがあります。`z.coerce.number()`を使うと、バリデーションの前に値を数値型に強制変換してくれるため、型エラーを防ぐことができます。

## ✨ まとめ

-   `Zod`は、スキーマを定義することで、**バリデーションと型の両方を一度に得られる**、TypeScriptと非常に相性の良いライブラリである。
-   バリデーションルールと型定義を一元管理することで、コードの信頼性とメンテナンス性が向上する。
-   `React Hook Form`と`@hookform/resolvers`を組み合わせることで、`Zod`スキーマをバリデーションルールとしてシームレスに統合できる。
-   この組み合わせは、現代のReact開発におけるフォーム実装のベストプラクティスの一つであり、堅牢でスケーラブルなフォームを効率的に構築するための強力な武器となる。
