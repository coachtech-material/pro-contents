# Col-2-2: Server-Side Rendering (SSR)

## 🎯 このセクションで学ぶこと

-   サーバーサイドレンダリング（SSR）の基本的な仕組みを理解する。
-   SSRのメリット（高速な初期表示、SEOへの強さ）とデメリット（サーバー負荷、TTIの遅延）を学ぶ。
-   SSRにおけるハイドレーションの概念とその重要性を理解する。

## 導入

クライアントサイドレンダリング（CSR）が抱える初期表示の遅さやSEOの問題を解決するアプローチとして、古くからあり、そして再び注目されているのが**サーバーサイドレンダリング（Server-Side Rendering, SSR）**です。LaravelやRuby on Railsのような伝統的なWebフレームワークは、元来このSSR方式を採用しています。

近年では、Next.jsやNuxt.jsといったJavaScriptフレームワークによって、ReactやVueを使いながらSSRのメリットを享受できるようになり、「モダンなSSR」が広く使われるようになりました。

## SSRの仕組み

SSRでは、ユーザーがページにアクセスするたびに、サーバー側でリクエストに応じた完全なHTMLを生成してクライアントに返します。ブラウザは、受け取ったHTMLをすぐに表示できるため、ユーザーは素早くコンテンツを見ることができます。[1]

SSRの処理フローは以下のようになります。

1.  **Initial Request**: ユーザーがURLにアクセスすると、ブラウザはサーバーにリクエストを送信します。
2.  **Fetch Data & Render HTML on Server**: サーバーはリクエストを受け取ると、必要なデータをデータベースなどから取得し、そのデータを使って**サーバー上で**完全なHTMLコンテンツをレンダリングします。
3.  **Full HTML Response**: サーバーは、レンダリング済みのHTMLをクライアントに返します。このHTMLには、ユーザーが見るべきすべてのコンテンツが含まれています。
4.  **Browser Renders HTML**: ブラウザはHTMLを受け取るとすぐに解析し、ページを描画します。この時点で、ユーザーはコンテンツを閲覧できます（**First Contentful Paint, FCP**が速い）。
5.  **Download & Execute JavaScript**: HTMLの描画と並行して、ブラウザはJavaScriptファイルをダウンロードします。
6.  **Hydration**: JavaScriptの実行が完了すると、静的なHTMLに対してイベントリスナーなどをアタッチし、ページをインタラクティブにします。このプロセスを**ハイドレーション**と呼びます。

![SSRの処理フロー](https://raw.githubusercontent.com/coachtech-material/pro-contents/main/laravel%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89%E5%AD%A6%E7%BF%92%E3%83%AD%E3%83%BC%E3%83%89%E3%83%9E%E3%83%83%E3%83%97/images/column/ssr-flow.png)

## SSRのメリット

### 1. 高速な初期表示（FCPの改善）

SSRの最大のメリットは、**初期表示が非常に速い**ことです。ブラウザは最初のリクエストで完全なHTMLを受け取るため、JavaScriptのダウンロードや実行を待つことなく、すぐにコンテンツを描画できます。これにより、ユーザーの体感速度が大幅に向上し、離脱率の低下に繋がります。

### 2. SEO（検索エンジン最適化）に強い

サーバーが完全なHTMLを返すため、検索エンジンのクローラーはJavaScriptを実行することなく、ページの内容を確実に理解し、インデックスすることができます。これは、ブログ、ニュースサイト、ECサイトなど、検索流入がビジネス上重要なアプリケーションにとって大きな利点です。

## SSRのデメリット

### 1. サーバー負荷の増大

SSRでは、ユーザーからのリクエストごとにサーバー上でHTMLのレンダリング処理が実行されます。多くのユーザーが同時にアクセスすると、サーバーのCPU負荷が高くなり、レスポンスが遅延する可能性があります。そのため、CSRに比べて高いスペックのサーバーが必要になったり、キャッシュ戦略を慎重に設計する必要があったりします。

### 2. Time to Interactive (TTI) の遅延

SSRはFCPを高速化しますが、ページが完全にインタラクティブになるまでの時間（**Time to Interactive, TTI**）は、CSRと同様にJavaScriptのダウンロードと実行（ハイドレーション）が終わるまで待たなければなりません。ユーザーはコンテンツを見えているのに、ボタンをクリックしても反応しない、という「不気味の谷」のような状態が発生することがあります。

> サーバーサイド レンダリングでは、ユーザーはコンテンツをすばやく表示できますが、クライアントサイドの JavaScript が実行されてイベント ハンドラーがアタッチされるまで、そのコンテンツを操作することはできません。これは、Time to Interactive (TTI) が遅くなる可能性があることを意味します。
> --- Vercel, "What is Server-Side Rendering?" [2]

### 3. 開発の複雑さ

モダンなSSR（Next.jsなど）では、開発者はサーバーサイドとクライアントサイドの両方の環境を意識する必要があります。例えば、サーバーサイドでは`window`や`document`といったブラウザ固有のオブジェクトにアクセスできないため、コードの書き方に注意が必要です。

## ハイドレーション（Hydration）とは？

SSRの文脈で非常に重要な概念が**ハイドレーション**です。これは、サーバーから送られてきた静的なHTMLの骨格に、クライアントサイドでダウンロードしたJavaScriptを使って「魂を吹き込む（＝インタラクティブにする）」プロセスです。

具体的には、Reactなどのフレームワークが、サーバーでレンダリングされたDOM構造と、クライアントサイドでこれからレンダリングしようとしているコンポーネントツリーを比較し、一致していればDOMを再生成する代わりに、既存のDOMにイベントリスナー（例: `onClick`）などをアタッチしていきます。これにより、効率的にページをインタラクティブな状態に移行させることができます。

もしサーバーで生成されたHTMLとクライアントで生成されたHTMLが一致しない場合、**ハイドレーションミスマッチ**エラーが発生し、ReactはクライアントサイドでDOM全体を再構築しようとします。これはパフォーマンスの低下に繋がるため、避けるべきです。

## ✨ まとめ

-   SSRは、リクエストごとにサーバー側で完全なHTMLを生成してクライアントに返す方式。
-   **メリット**: 高速な初期表示（FCP）、SEOに強い。
-   **デメリット**: サーバー負荷の増大、TTIの遅延、開発の複雑さ。
-   **ハイドレーション**: サーバーから送られた静的HTMLに、クライアントのJavaScriptでインタラクティブ性を付与するプロセス。
-   ブログやECサイトなど、初期表示速度とSEOが重要なコンテンツ主体のサイトに適している。

次のセクションでは、SSRと似て非なるアプローチである静的サイト生成（SSG）について学びます。

---

## 参考文献

[1] web.dev. (n.d.). *Rendering on the Web*. Retrieved from https://web.dev/articles/rendering-on-the-web

[2] Vercel. (n.d.). *What is Server-Side Rendering?*. Retrieved from https://vercel.com/docs/getting-started-with-vercel/concepts/rendering#server-side-rendering-ssr
