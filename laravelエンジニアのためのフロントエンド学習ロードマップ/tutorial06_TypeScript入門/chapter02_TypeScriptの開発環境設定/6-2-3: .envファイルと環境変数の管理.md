# 6-2-3: .envファイルと環境変数の管理

## 🎯 このセクションで学ぶこと

- 環境変数がなぜ重要なのか、特にセキュリティの観点から説明できるようになる
- `.env` ファイルを使って、開発環境と本番環境で異なる設定値を管理する方法を習得する
- フロントエンド（特にReact/Next.js）で環境変数を安全に読み込む方法を理解する

## 導入

Laravel開発者であれば、`.env` ファイルは非常にお馴染みの存在でしょう。データベースの接続情報やAPIキーなど、環境によって異なり、かつGitなどのバージョン管理に含めてはいけない機密情報を管理するために使います。

この「**設定とコードの分離**」という考え方は、フロントエンド開発においても同様に非常に重要です。接続するAPIのエンドポイントURLは、ローカル開発環境と本番環境では異なります。また、外部サービスのAPIキーをGitHubに公開してしまうと、不正利用され、高額な請求に繋がる重大なセキュリティインシデントを引き起こします。

このセクションでは、フロントエンド開発における環境変数の標準的な管理方法として、`.env` ファイルの役割と安全な使い方を学びます。

## 詳細解説

### 🔑 環境変数とは？

環境変数とは、アプリケーションが実行される環境（OSやビルドプロセス）から渡される、動的な設定値のことです。主な利点は以下の通りです。

- **セキュリティの向上**: APIキーやパスワードなどの機密情報をコードベースから分離し、Gitリポジトリに含めないようにできる。
- **ポータビリティの向上**: 同じコードを、異なる設定（開発、ステージング、本番）で動かすことができる。
- **設定管理の簡素化**: 環境ごとの設定値を一箇所（`.env`ファイル）で管理できる。

### `.env` ファイルの役割

`.env` ファイルは、`キー=値` の形式で環境変数を定義するシンプルなテキストファイルです。このファイルは、プロジェクトのルートディレクトリに配置します。

```env
# データベース接続情報 (バックエンドの例)
DB_HOST=localhost
DB_USER=root
DB_PASS=password

# フロントエンドで使うAPIのエンドポイント
API_BASE_URL=http://localhost:8000/api

# 外部サービスのAPIキー
GOOGLE_MAPS_API_KEY=AIzaSyXXXXXXXXXXXXXXXXXXX
```

**⚠️ 最も重要なルール: `.gitignore` に `.env` を追加する**

`.env` ファイルには機密情報が含まれるため、**絶対にGitで管理してはいけません**。プロジェクトの `.gitignore` ファイルに以下の1行を必ず追加してください。

```
.env
```

代わりに、チームメンバーがどのような環境変数を設定すべきか分かるように、`env.example` というファイルをリポジトリに含めるのが一般的です。このファイルには、実際の値の代わりにダミーの値を記述します。

```env
# .env.example
API_BASE_URL=http://localhost:8000/api
GOOGLE_MAPS_API_KEY=
```

### フロントエンドでの環境変数の扱い

Laravelでは、PHPがサーバーサイドで `.env` ファイルを読み込み、`env()` ヘルパーで簡単にアクセスできました。しかし、フロントエンドのJavaScriptはユーザーのブラウザ上で実行されるため、サーバー上の `.env` ファイルに直接アクセスすることはできません。

フロントエンドで環境変数を利用するには、**ビルドプロセス**中に `.env` ファイルの内容をコードに埋め込む必要があります。ViteやNext.jsのようなモダンなフロントエンドツールには、この仕組みが標準で組み込まれています。

#### Vite / Create React App での規約

ViteやCreate React Appでは、セキュリティ上の理由から、特定のプレフィックスが付いた環境変数のみがフロントエンドのコードに公開されます。

- **`VITE_`** (Viteの場合)
- **`REACT_APP_`** (Create React Appの場合)

```env
# この変数はフロントエンドのコードからアクセスできる
VITE_API_BASE_URL=http://localhost:8000/api

# この変数はフロントエンドからはアクセスできない（ビルドサーバー内でのみ利用可能）
SECRET_KEY=my-secret-key
```

JavaScriptコードからは、`import.meta.env` (Vite) や `process.env` (CRA) を通じてアクセスします。

```typescript
// Viteの場合
const apiUrl = import.meta.env.VITE_API_BASE_URL;
console.log(apiUrl); // "http://localhost:8000/api"

// Create React Appの場合
// const apiUrl = process.env.REACT_APP_API_BASE_URL;
```

#### Next.js での規約

Next.jsでは、プレフィックス **`NEXT_PUBLIC_`** を付けた環境変数がブラウザに公開されます。

```env
# この変数はブラウザ（フロントエンド）からアクセスできる
NEXT_PUBLIC_API_BASE_URL=http://localhost:3000/api

# この変数はサーバーサイド（getStaticPropsなど）でのみアクセスできる
API_SERVER_KEY=server-side-secret
```

コードからは `process.env` を使ってアクセスします。

```typescript
const apiUrl = process.env.NEXT_PUBLIC_API_BASE_URL;
```

**なぜプレフィックスが必要なのか？**

この仕組みは、誤ってサーバーサイド専用の秘密鍵などをフロントエンドに公開してしまう事故を防ぐための、重要な**セーフガード**です。「`VITE_`」や「`NEXT_PUBLIC_`」を付けることで、「**この変数はクライアントサイドに公開しても安全である**」という開発者の明確な意思表示となります。

## 💡 TIP

- 環境変数の型定義を行うことで、TypeScriptの恩恵をさらに享受できます。例えば、`import.meta.env` の型定義ファイルを作成し、`VITE_API_BASE_URL` が `string` 型であることを保証できます。これにより、環境変数名のタイポなどを防ぐことができます。

## ✨ まとめ

- `.env` ファイルは、APIキーなどの機密情報や環境依存の設定をコードから分離するために使用する。
- `.env` ファイルは、必ず `.gitignore` に追加し、バージョン管理から除外する。
- フロントエンドで環境変数を使うには、ビルドプロセスで値を埋め込む必要があり、ViteやNext.jsなどのツールにはその仕組みが組み込まれている。
- セキュリティのため、フロントエンドに公開する環境変数には、`VITE_` や `NEXT_PUBLIC_` といった特定のプレフィックスを付ける必要がある。
