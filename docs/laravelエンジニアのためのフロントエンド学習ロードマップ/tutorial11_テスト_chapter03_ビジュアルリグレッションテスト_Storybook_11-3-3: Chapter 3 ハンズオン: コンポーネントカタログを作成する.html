<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 3 ハンズオン: コンポーネントカタログを作成する | pro-contents</title>
    <meta name="description" content="プログラミング教材コンテンツ">
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div id="outer">
        <header>
            <h1><a href="index.html">pro-contents</a></h1>
            <p class="description">プログラミング教材コンテンツ</p>
        </header>
        <div id="container">
            <aside>
                <div id="side-inner">
                    <div class="side-title">チュートリアル一覧</div>
<div class="side"><ul>
<li><a href="tutorial01_開発環境とWebの基礎固め.html">Tutorial 1: 開発環境とWebの基礎固め</a></li>
<li><a href="tutorial02_HTML_CSS基礎.html">Tutorial 2: HTML/CSS基礎</a></li>
<li><a href="tutorial03_Tailwind_CSS徹底習得.html">Tutorial 3: Tailwind CSS徹底習得</a></li>
<li><a href="tutorial04_JavaScript_基礎とDOM操作.html">Tutorial 4: JavaScript基礎とDOM操作</a></li>
<li><a href="tutorial05_JavaScript_応用と非同期処理.html">Tutorial 5: JavaScript応用と非同期処理</a></li>
<li><a href="tutorial06_TypeScript入門.html">Tutorial 6: TypeScript入門</a></li>
<li><a href="tutorial07_React入門.html">Tutorial 7: React入門</a></li>
<li><a href="tutorial08_React応用.html">Tutorial 8: React応用</a></li>
<li><a href="tutorial09_Next.js.html">Tutorial 9: Next.js</a></li>
<li><a href="tutorial10_Laravel_x_Next.js.html">Tutorial 10: Laravel × Next.js</a></li>
<li><a href="tutorial11_テスト.html" class="current">Tutorial 11: テスト</a></li>
<li><a href="tutorial12_column.html">上級コラム: Webレンダリングの深層理解</a></li>
</ul></div>

                </div>
            </aside>
            <div id="content">
                <div class="inner">
                    <div class="breadcrumb"><a href="../index.html">ホーム</a><span>></span><a href="index.html">Laravelエンジニアのためのフロントエンド学習ロードマップ</a><span>></span><a href="tutorial11_テスト.html">Tutorial 11: テスト</a><span>></span><a href="tutorial11_テスト_chapter03_ビジュアルリグレッションテスト_Storybook.html">Chapter 3: ビジュアルリグレッションテスト Storybook</a><span>></span>Chapter 3 ハンズオン: コンポーネントカタログを作成する</div>
                    <div class="section-content">
<h1 id="11-3-3-chapter-3">11-3-3: Chapter 3 ハンズオン: コンポーネントカタログを作成する</h1>
<h2 id="_1">🎯 このセクションで学ぶこと</h2>
<ul>
<li>StorybookとPlaywrightを連携させて、ビジュアルリグレッションテスト（VRT）を実装する方法を学ぶ</li>
<li><code>@storybook/test-runner</code>を使って、Storybookの全Storyを自動でテストするワークフローを構築する</li>
<li>Playwrightの<code>toHaveScreenshot()</code>マッチャーを使って、スクリーンショットの差分比較を行う方法を習得する</li>
</ul>
<h2 id="_2">導入</h2>
<p>前のセクションで、Storybookを使ってUIコンポーネントのカタログを作成しました。このハンズオンでは、そのカタログを利用して、UIの「見た目」を自動テストする<strong>ビジュアルリグレッションテスト（VRT）</strong>を構築します。</p>
<p>今回は、Storybook公式が提供している<code>@storybook/test-runner</code>と、E2Eテストでも使用したPlaywrightを組み合わせてVRTを実現します。このアプローチの利点は、既存のPlaywrightの知識を活かせ、追加のツール（ChromaticやPercyなど）を導入することなくVRTを始められる点です。</p>
<h2 id="vrt">VRTの仕組み</h2>
<p><code>@storybook/test-runner</code>は、Storybookに登録されているすべてのStoryを巡回し、各StoryをPlaywrightで開いてテストを実行するためのツールです。</p>
<p>テストの具体的な流れは以下のようになります。</p>
<ol>
<li><code>@storybook/test-runner</code>がStorybookを内部的にビルドする。</li>
<li>ビルドされたStorybookの各Story（例: <code>Button--primary</code>）に対して、Playwrightテストを生成・実行する。</li>
<li>Playwrightは、指定されたStoryのページを開き、<code>page.screenshot()</code>または<code>expect(page).toHaveScreenshot()</code>を使ってスクリーンショットを撮影する。</li>
<li><strong>初回実行時</strong>: 撮影したスクリーンショットが「基準（Baseline）画像」として、<code>__screenshots__</code>ディレクトリに保存される。</li>
<li><strong>2回目以降</strong>: 新しく撮影したスクリーンショットと、保存されている基準画像を比較する。</li>
<li>差分がなければテストは成功。差分があればテストは失敗し、差分画像（diff）が生成される。</li>
</ol>
<h2 id="_3">セットアップ</h2>
<h3 id="1">ステップ1: 必要なライブラリのインストール</h3>
<p>まず、<code>@storybook/test-runner</code>と、PlaywrightをStorybookから利用するための<code>@storybook/test-playwright</code>をインストールします。</p>
<pre class="codehilite"><code class="language-bash">npm install -D @storybook/test-runner @storybook/test-playwright
</code></pre>

<h3 id="2">ステップ2: テストスクリプトの追加</h3>
<p><code>package.json</code>の<code>scripts</code>に、VRTを実行するためのコマンドを追加します。</p>
<pre class="codehilite"><code class="language-json">// package.json
{
  ...
  &quot;scripts&quot;: {
    ...
    &quot;test:vrt&quot;: &quot;test-storybook&quot;
  },
  ...
}
</code></pre>

<h3 id="3-playwright">ステップ3: Playwrightテストファイルの作成</h3>
<p><code>@storybook/test-runner</code>が各Storyに対して実行するテストの内容を記述するファイルを作成します。プロジェクトのルートに<code>test-runner-jest.config.js</code>（Jestの設定ファイル）と、テストロジックを記述する<code>vrt.test.js</code>を作成します。</p>
<p>まず、<code>test-runner-jest.config.js</code>を作成します。</p>
<pre class="codehilite"><code class="language-javascript">// test-runner-jest.config.js
const { getJestConfig } = require('@storybook/test-runner');

module.exports = {
  // Storybook test-runnerのデフォルト設定を継承
  ...getJestConfig(),
  // ここで必要に応じて設定を上書きできる
  testMatch: ['**/vrt.test.js'],
};
</code></pre>

<p>次に、VRTの本体となる<code>vrt.test.js</code>を作成します。</p>
<pre class="codehilite"><code class="language-javascript">// vrt.test.js
const { test, expect } = require('@playwright/test');
const { createTestServer } = require('@storybook/test-server');
const { injectAxe, checkA11y } = require('axe-playwright');

let server;

beforeAll(async () =&gt; {
  server = await createTestServer();
});

afterAll(async () =&gt; {
  await server.close();
});

describe('VRT', () =&gt; {
  test.beforeEach(async ({ page }) =&gt; {
    await page.goto(server.url);
    await injectAxe(page);
  });

  // Storybookの全Storyに対してテストを実行
  server.stories.forEach((story) =&gt; {
    test(story.id, async ({ page }) =&gt; {
      await page.goto(server.url + '?path=/story/' + story.id);
      // アクセシビリティチェック
      await checkA11y(page, '#storybook-root', {
        detailedReport: true,
        detailedReportOptions: {
          html: true,
        },
      });
      // スクリーンショット比較
      await expect(page).toHaveScreenshot(`${story.id}.png`);
    });
  });
});
</code></pre>

<p><strong>コードのポイント:</strong></p>
<ul>
<li><code>createTestServer</code>: Storybookをビルドし、テスト用のサーバーを起動します。</li>
<li><code>server.stories</code>: Storybookに登録されている全StoryのIDと名前のリストです。これをループさせることで、すべてのStoryに対してテストを実行できます。</li>
<li><code>page.goto(server.url + '?path=/story/' + story.id)</code>: 各Storyの独立したページ（iframe内ではない）にアクセスします。</li>
<li><code>checkA11y</code>: <code>axe-playwright</code>によるアクセシビリティチェックです。VRTと同時に行うと効果的です。</li>
<li><strong><code>expect(page).toHaveScreenshot(...)</code></strong>: Playwrightの強力な機能で、ページのスクリーンショットを撮影し、基準画像との比較を行います。ファイル名を指定するだけで、差分比較のロジック全体を抽象化してくれます。</li>
</ul>
<h2 id="vrt_1">VRTの実行</h2>
<p>準備が整ったので、VRTを実行してみましょう。</p>
<h3 id="_4">初回実行（基準画像の作成）</h3>
<pre class="codehilite"><code class="language-bash">npm run test:vrt
</code></pre>

<p>初回実行時は、比較対象の基準画像が存在しないため、すべてのテストが失敗します。しかし、これにより<code>__screenshots__</code>ディレクトリ以下に、現在のコンポーネントの見た目を「正解」とする基準画像が生成されます。</p>
<p>生成された画像を確認し、これが期待通りの見た目であれば、これらの画像をGitにコミットします。</p>
<h3 id="2_1">2回目以降の実行（差分比較）</h3>
<p>では、意図的にコンポーネントの見た目を変更してみましょう。<code>src/components/ui/Button.tsx</code>の<code>primary</code>バリアントの背景色を<code>bg-blue-500</code>から<code>bg-green-500</code>に変更します。</p>
<pre class="codehilite"><code class="language-tsx">// ...
variants: {
  variant: {
    primary: &quot;bg-green-500 text-white hover:bg-green-600&quot;, // 変更
    // ...
  },
// ...
</code></pre>

<p>この状態で、再度VRTを実行します。</p>
<pre class="codehilite"><code class="language-bash">npm run test:vrt
</code></pre>

<p>今度は、<code>Button--primary</code>のStoryに対応するテストが失敗するはずです。Playwrightは、<code>test-results</code>ディレクトリに差分画像（<code>diff</code>）を生成します。これを見ると、どこがどのように変わったのかが一目瞭然です。</p>
<p><img alt="VRTの差分画像" src="https://raw.githubusercontent.com/coachtech-material/pro-contents/main/laravel%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89%E5%AD%A6%E7%BF%92%E3%83%AD%E3%83%BC%E3%83%89%E3%83%9E%E3%83%83%E3%83%97/images/tutorial-11/vrt-diff.png" /></p>
<h3 id="_5">基準画像の更新</h3>
<p>もしこの変更が意図したものであれば（例: デザイン仕様の変更）、基準画像を更新する必要があります。<code>--update-snapshots</code>フラグをつけてテストを実行すると、既存の基準画像が新しいスクリーンショットで上書きされます。</p>
<pre class="codehilite"><code class="language-bash">npm run test:vrt -- --update-snapshots
</code></pre>

<p>更新された基準画像をGitにコミットすれば、次回のテストからは新しい見た目が「正解」となります。</p>
<h2 id="_6">✨ まとめ</h2>
<ul>
<li><code>@storybook/test-runner</code>とPlaywrightを組み合わせることで、ローカル環境でVRTを構築できる。</li>
<li><code>test-runner</code>がStorybookの全Storyを巡回し、Playwrightで各Storyのスクリーンショットを撮影する。</li>
<li><code>expect(page).toHaveScreenshot()</code>を使うことで、スクリーンショットの撮影から差分比較までを簡単に行える。</li>
<li>初回実行で「基準画像」を作成し、2回目以降はその基準画像との差分を検出する。</li>
<li>意図した変更の場合は、<code>--update-snapshots</code>フラグで基準画像を更新する。</li>
</ul>
<p>これで、ユニットテスト（機能）、E2Eテスト（ユーザーフロー）、そしてビジュアルリグレッションテスト（見た目）という、フロントエンドテストの3つの主要な柱をすべて実践できるようになりました。これらのテストをCI/CDパイプラインに組み込むことで、アプリケーションの品質と開発速度を大幅に向上させることができます。</p>
</div>
<div class="section-nav">
<a href="tutorial11_テスト_chapter03_ビジュアルリグレッションテスト_Storybook_11-3-2: Storybookの基本.html" class="prev">Storybookの基本</a>
<span></span>
</div>

                </div>
            </div>
        </div>
        <footer>
            &copy; 2025 pro-contents
        </footer>
    </div>
</body>
</html>
